stages:
    - build
build_project:
    stage: build
#    only:
#        - tags
    tags:
        - xcode
        - cocoapods
        - ios
    script:
        #- xcodebuild clean -workspace loahelper.xcworkspace -scheme loahelper | xcpretty
        - pod repo update
        - pod install
        - scheme_list=$(xcodebuild -list -json | tr -d "\n")
        - projectname=$(echo $scheme_list | ruby -e "require 'json'; puts JSON.parse(STDIN.gets)['project']['targets'][0]")
        - versionstring=$(xcodebuild -project ${projectname}.xcodeproj -showBuildSettings | grep "MARKETING_VERSION" | cut -d '=' -f 2 | xargs)
        - versionnumber=$(xcodebuild -project ${projectname}.xcodeproj -showBuildSettings | grep "CURRENT_PROJECT_VERSION" | cut -d '=' -f 2 | xargs)
        - archivename=${projectname}_${versionstring}_${versionnumber}
        - serverfile=$(pwd)/$projectname/server.plist
        - openssl base64 -d -in $SERVER_FILE -out serverfile
        - xcodebuild -workspace ${projectname}.xcworkspace -scheme ${projectname} clean archive -configuration Release -archivePath archives/${archivename}.xcarchive | xcpretty
        - xcodebuild -exportArchive -archivePath archives/${archivename}.xcarchive -exportOptionsPlist AppStoreUpload.plist -exportPath exports | xcpretty
        - xcrun altool --upload-app -f exports/${projectname}.ipa -u $APPLE_ID -p $APPLE_PWD | xcpretty
        #- xcodebuild -workspace loahelper.xcworkspace -scheme loahelper -destination 'platform=iOS Simulator,name=iPhone 12 Pro Max,OS=14.1' | xcpretty -s
        - cd ../../
        - rm -rf ./*
    tags:
        - xcode
        - cocoapods
        - ios
        



